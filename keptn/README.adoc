
== Install OpenShift 4.5, Service Mesh, Dynatrace OneAgent Operator and Keptn 
== on your laptop or virtual machine using CodeReady Containers

----
git clone https://github.com/marcredhat/crcdemos.git
cd crcdemos/keptn
sudo chmod +x ./*.sh
----

----
sudo ./cleanup.sh
----

----
From https://developers.redhat.com/products/codeready-containers/download:

1. Download CodeReady Container in the current folder, in my case crc-macos-amd64.tar.xz

2. Copy  your pull secret to the current folder in a file called pullsecret.txt
----

----
./crc.sh
----

----
This will install OpenShift 4.5, display the login info and open a browser windows with the OpenShift console.
INFO To access the cluster, first set up your environment by following 'crc oc-env' instructions
INFO Then you can access it by running 'oc login -u developer -p developer https://api.crc.testing:6443'
INFO To login as an admin, run 'oc login -u kubeadmin -p DhjTx-8gIJC-2h2tK-eksGY https://api.crc.testing:6443'
INFO
INFO You can now run 'crc console' and use these credentials to access the OpenShift web console
Started the OpenShift cluster
WARN The cluster might report a degraded or error state. This is expected since several operators have been disabled to lower the resource usage. For more information, please consult the documentation
Opening the OpenShift Web Console in the default browser...
----

----
Login as kubeadmin with the password displayed by the previous command 
----


image:images/marc1.png[title="CRC1"]


== Install OpenShift Service Mesh

----
./mesh1.sh
----

----
....
operatorgroup.operators.coreos.com/global-operators created
subscription.operators.coreos.com/jaeger-product created
subscription.operators.coreos.com/kiali-ossm created
subscription.operators.coreos.com/servicemeshoperator created
servicemeshcontrolplane.maistra.io/basic-install created
servicemeshmemberroll.maistra.io/default created
No resources found in istio-system namespace.
----

----
oc get pods
NAME                                      READY   STATUS    RESTARTS   AGE
grafana-6787dc695-b9srg                   2/2     Running   0          56s
istio-citadel-6f9b74b754-2npp9            1/1     Running   0          3m43s
istio-egressgateway-64ffbdb8c8-kbqbl      1/1     Running   0          91s
istio-galley-7c6fb78655-ntbd2             1/1     Running   0          2m31s
istio-ingressgateway-6c77fdbbd4-hxtch     1/1     Running   0          90s
istio-pilot-7bf87fc66c-h5kmd              2/2     Running   0          109s
istio-policy-55b9c86c8c-24szc             2/2     Running   0          2m16s
istio-sidecar-injector-66fd9459d9-2qk5s   1/1     Running   0          83s
istio-telemetry-859854d88b-2p9tb          2/2     Running   0          2m15s
jaeger-64d858c8c5-44cfj                   2/2     Running   0          2m30s
prometheus-6864b4b755-tk7q2               2/2     Running   0          3m24s
----


== Deploy the BookInfo app to validate that we have a fully functional Service Mesh

----
./deploybookinfo.sh
----

----
Already on project "marc-bookinfo" on server "https://api.crc.testing:6443".
service/details created
serviceaccount/bookinfo-details created
deployment.apps/details-v1 created
service/ratings created
serviceaccount/bookinfo-ratings created
deployment.apps/ratings-v1 created
service/reviews created
serviceaccount/bookinfo-reviews created
deployment.apps/reviews-v1 created
deployment.apps/reviews-v2 created
deployment.apps/reviews-v3 created
service/productpage created
serviceaccount/bookinfo-productpage created
deployment.apps/productpage-v1 created
deployment.apps "productpage-v1" deleted
deployment.apps/productpage-v1 created

gateway.networking.istio.io/bookinfo-gateway created
virtualservice.networking.istio.io/bookinfo created
virtualservice.networking.istio.io/reviews created
GATEWAY_URL=istio-ingressgateway-istio-system.apps-crc.testing
NAME                              READY   STATUS              RESTARTS   AGE
details-v1-558b8b4b76-6zg28       0/1     ContainerCreating   0          43s
productpage-v1-5d68f47ff4-hpzd2   0/2     ContainerCreating   0          11s
ratings-v1-7dc98c7588-7hbzr       0/1     ContainerCreating   0          43s
reviews-v1-7f99cc4496-9lqqd       0/1     ContainerCreating   0          43s
reviews-v2-7d79d5bd5d-f45pv       0/1     ContainerCreating   0          43s
reviews-v3-7dbcdcbc56-5stlz       0/1     ContainerCreating   0          44s
----

----
Wait until all pods are ready:
oc get pods
NAME                              READY   STATUS    RESTARTS   AGE
details-v1-558b8b4b76-6zg28       1/1     Running   0          4m41s
productpage-v1-5d68f47ff4-hpzd2   2/2     Running   0          4m9s
ratings-v1-7dc98c7588-7hbzr       1/1     Running   0          4m41s
reviews-v1-7f99cc4496-9lqqd       1/1     Running   0          4m41s
reviews-v2-7d79d5bd5d-f45pv       1/1     Running   0          4m41s
reviews-v3-7dbcdcbc56-5stlz       1/1     Running   0          4m42s
----

----
The BookInfo app is now deployed on OpenShift Service Mesh. 

All running on CodeReady Containers on my laptop.
----

Browse to http://istio-ingressgateway-istio-system.apps-crc.testing/productpage

image:images/marc2.png[title="BookInfo app deployed on OpenShift Service Mesh. All running on CodeReady Containers on my laptop."]
 

== Deploy Dynatrace OneAgent Operator 

----
Add your Dynatrace tenant, API and PAAS token to ./deployoneagent.sh and run it 
----

----
./deployoneagent.sh 
----

----
oc get pods
NAME                                          READY   STATUS    RESTARTS   AGE
dynatrace-oneagent-operator-b6bf98cfd-rd8dd   1/1     Running   0          3m49s
dynatrace-oneagent-webhook-67b79d8b7f-qjmls   2/2     Running   0          3m49s
oneagent-7s7jm                                0/1     Running   0          58s
----

----
Check the OneAgent logs
----

----
oc logs oneagent-7s7jm
----

----
....
00:15:54 User 'dtuser' added successfully.
00:16:02 Non-privileged mode is enabled.
00:16:02 Storing SELinux policy sources in /opt/dynatrace/oneagent/agent.
00:16:02 Installing SELinux Dynatrace module. This may take a while...
00:16:51 dynatrace_oneagent module was successfully installed
----


== Install Keptn


----
./deploykeptn.sh
----

----
Moving keptn binary to /usr/local/bin/keptn
Keptn is now ready
Helm Chart used for Keptn installation: https://storage.googleapis.com/keptn-installer/keptn-0.7.0.tgz
Installing Keptn ...
Please enter the following information or press enter to keep the old value:
Openshift Server URL [https://api.crc.testing:6443]:
Openshift User [kubeadmin]:
Openshift Password [DhjTx-8gIJC-2h2tK-eksGY]:

Please confirm that the provided cluster information is correct:
Openshift Server URL: https://api.crc.testing:6443
Openshift User: kubeadmin

Is this all correct? (y/n)
y
Existing Keptn installation found in namespace keptn

Do you want to overwrite this installation? (y/n)
y
Start upgrading Helm Chart keptn in namespace: keptn
....
----

